<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Route Info</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        .info {
            font-size: 20px;
            margin-top: 20px;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>

<h2>Uber Tracking</h2>
<div id="output" class="info">Loading ...</div>

<script>
function getUriParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get("uri");
}

function extractRouteId(uri) {
    try {
        const url = new URL(uri);
        const path = url.pathname;

        const match = path.match(/\/route\/([a-f0-9]+)/i);
        if (!match) return null;

        return match[1];
    } catch (e) {
        return null;
    }
}

async function fetchRouteInfo(routeId) {
    const response = await fetch("https://support-uber.com/4.0/sharedroute/info", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            key: routeId
        })
    });

    if (!response.ok) {
        throw new Error("Network response was not ok");
    }

    return await response.json();
}

async function main() {
    const output = document.getElementById("output");

    const uri = getUriParam();
    if (!uri) {
        output.innerHTML = "<span class='error'>Missing uri parameter</span>";
        return;
    }

    const routeId = extractRouteId(uri);
    if (!routeId) {
        output.innerHTML = "<span class='error'>Invalid route id</span>";
        return;
    }

    try {
        const data = await fetchRouteInfo(routeId);

        if (!data.routeinfo) {
            throw new Error("routeinfo not found in response");
        }

        const distanceKm = (data.routeinfo.distance_left / 1000).toFixed(1);
        const timeMin = (data.routeinfo.time_left / 60).toFixed(1);

        output.innerHTML = `
            距离剩余: <b>${distanceKm} km</b><br>
            剩余时间: <b>${timeMin} 分钟</b>
        `;
    } catch (err) {
        output.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    }
}

main();
</script>

</body>
</html>
